# Steps for restoring project cache

steps:
  - task: DownloadBuildArtifacts@0
    condition: succeeded()
    displayName: '[Cache][Restore] Restore install'
    inputs:
        buildType: 'specific'
        project: '$(System.TeamProject)'
        pipeline: '$(Build.DefinitionName)'
        branchName: 'refs/heads/master'
        buildVersionToDownload: 'latestFromBranch'
        downloadType: 'single'
        artifactName: 'cache-$(Agent.OS)-install'
        downloadPath: '$(Build.StagingDirectory)'
    continueOnError: true

  - bash: 'mkdir -p $(ESY__CACHE_INSTALL_PATH)'
    condition: succeeded()
    displayName: '[Cache][Restore] Create cache directory'

  - bash: 'cd $(ESY__CACHE_INSTALL_PATH) && tar -xf $(Build.StagingDirectory)/cache-$(Agent.OS)-install/esy-cache.tar -C .'
    continueOnError: true
    condition: succeeded()
    displayName: '[Cache][Restore] Untar esy cache directory'

  - bash: 'rm -rf *'
    continueOnError: true
    workingDirectory: '$(Build.StagingDirectory)'
    condition: succeeded()
    displayName: '[Cache][Restore] Clean up'
